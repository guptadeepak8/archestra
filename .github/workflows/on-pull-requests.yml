name: On Pull Requests

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
  # You can use the merge_group event to trigger your GitHub Actions workflow when
  # a pull request is added to a merge queue
  # https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/configuring-pull-request-merges/managing-a-merge-queue#triggering-merge-group-checks-with-github-actions
  merge_group:

concurrency:
  # Cancel any running workflow for the same branch when new commits are pushed.
  # We group both by ref_name (available when CI is triggered by a push to a branch/tag)
  # and head_ref (available when CI is triggered by a PR).
  # For merge queue, we use merge_group to ensure each merge queue run gets its own group.
  group: "on-pull-requests-${{ github.ref_name }}-${{ github.head_ref }}-${{ github.event.merge_group.head_sha || '' }}"
  cancel-in-progress: true

jobs:
  lint-pr-title:
    name: PR Title Linter
    if: github.event_name == 'pull_request'
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      contents: read
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Lint PR title
        uses: grafana/shared-workflows/actions/lint-pr-title@19d8fb5687bb386849f7f53673c5f429e6387cf5 # v1.2.0
        with:
          config-path: "${{ github.workspace }}/.github/commitlint.config.js"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  zizmor:
    name: Zizmor GitHub Actions static analysis
    runs-on: blacksmith-4vcpu-ubuntu-2404
    permissions:
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      # From zizmor action docs:
      # https://github.com/zizmorcore/zizmor-action?tab=readme-ov-file#usage-with-github-advanced-security-recommended
      #
      # In this mode, the action will not fail when zizmor produces findings.
      # This is because Advanced Security encourages workflows to only fail on internal errors.
      #
      # To use workflow failure as a blocking signal, you can use GitHub's rulesets feature.
      # For more information, see:
      # https://docs.github.com/en/code-security/code-scanning/managing-code-scanning-alerts/about-code-scanning-alerts#pull-request-check-failures-for-code-scanning-alerts
      - name: Run zizmor ðŸŒˆ
        uses: zizmorcore/zizmor-action@e639db99335bc9038abc0e066dfcd72e23d26fb4 # v0.3.0
        with:
          config: .github/zizmor.yml

  platform-linting-and-tests-pr:
    name: Platform Linting and Tests (Optional)
    if: github.event_name == 'pull_request'
    permissions:
      contents: write
      security-events: write
      id-token: write # Required for Workload Identity Federation
      pull-requests: write # Required for Docker Scout to write a comment to a PR
    uses: ./.github/workflows/platform-linting-and-tests.yml
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBOREPO_REMOTE_CACHING_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

  platform-linting-and-tests-merge-queue:
    name: Platform Linting and Tests (Required)
    permissions:
      contents: write
      security-events: write
      id-token: write # Required for Workload Identity Federation
      pull-requests: write # Required for Docker Scout to write a comment to a PR
    uses: ./.github/workflows/platform-linting-and-tests.yml
    with:
      should-skip-running-and-always-succeed: ${{ github.event_name == 'pull_request' }}
    secrets:
      TURBOREPO_REMOTE_CACHING_TOKEN: ${{ secrets.TURBOREPO_REMOTE_CACHING_TOKEN }}
      TURBOREPO_REMOTE_CACHING_TEAM: ${{ secrets.TURBOREPO_REMOTE_CACHING_TEAM }}
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
